name: Deploy to Google Cloud Run (Staging)

on:
  push:
    branches:
      - staging
  pull_request:
    branches:
      - staging
    types: [opened, synchronize, reopened]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: aitutor-473420
          service_account_key: ${{ secrets.GCP_SA_KEY }}
          export_default_credentials: true

      - name: Grant execute permissions
        run: chmod +x ./deploy.sh

      - name: Set environment variables
        run: |
          echo "MONGODB_URI=${{ secrets.MONGODB_URI }}" >> $GITHUB_ENV
          echo "MONGODB_DB_NAME=${{ secrets.MONGODB_DB_NAME }}" >> $GITHUB_ENV
          echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" >> $GITHUB_ENV
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> $GITHUB_ENV
          echo "GEMINI_MODEL=${{ secrets.GEMINI_MODEL }}" >> $GITHUB_ENV

      - name: Deploy to staging
        if: github.event_name == 'push'
        run: ./deploy.sh staging
      
      - name: Validate deployment configuration (PR)
        if: github.event_name == 'pull_request'
        run: |
          echo "üîç Validating deployment configuration..."
          echo "‚úÖ Cloud Build config exists"
          test -f cloudbuild-staging.yaml
          echo "‚úÖ Deploy script exists"
          test -f deploy.sh
          echo "‚úÖ All Dockerfiles exist"
          test -f services/DashSystem/Dockerfile
          test -f services/SherlockEDApi/Dockerfile
          test -f services/TeachingAssistant/Dockerfile
          test -f services/MediaMixer/Dockerfile
          test -f services/Tutor/Dockerfile
          test -f frontend/Dockerfile
          echo "‚úÖ Configuration validation passed!"

